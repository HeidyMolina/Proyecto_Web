<% /* views/resultados.ejs */ %>
<%
function formatTiempo(segundos) {
  if (!segundos || isNaN(segundos)) return "-";
  const h = Math.floor(segundos / 3600);
  const m = Math.floor((segundos % 3600) / 60);
  const s = segundos % 60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}
%>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
  body {
    background: url('/images/fondo_verde.png') no-repeat center center fixed;
    background-size: cover;
    font-family: 'Press Start 2P', cursive, sans-serif;
    color: #fff;
  }
  .ranking {
    margin: 40px auto;
    text-align: center;
  }
  .ranking h2 {
    font-weight: bold;
    text-shadow: 2px 2px 4px #acc6e7;
    color: #000;
  }
  .tabla-resultados {
    background: rgba(0,0,0,0.7);
    border-radius: 15px;
    padding: 20px;
  }
  .table th {
    background: #198754;
    color: #fff;
    text-align: center;
  }
  .table td {
    text-align: center;
    background: #f8f9fa;
    color: #000;
  }

  .ganador-box {
  position: absolute;
  color: #000;
  font-weight: bold;
  padding: 8px;
  border-radius: 10px;
  text-align: center;
  width: 28%;
  min-width: 120px;
}

/* ðŸ¥‡ Oro - Centro */
.box-oro { 
  background: #FFD700; 
  top: 52%; 
  left: 50%; 
  transform: translateX(-50%); 
}

/* ðŸ¥ˆ Plata - Izquierda */
.box-plata { 
  background: #C0C0C0; 
  top: 62%; 
  left: 22%; 
  transform: translateX(-50%); 
}

/* ðŸ¥‰ Bronce - Derecha */
.box-bronce { 
  background: #CD7F32; 
  top: 64%; 
  left: 78%; 
  transform: translateX(-50%); 
}

</style>

<div class="container ranking animate__animated animate__fadeInDown">
  <h2>Ranking General de Juegos</h2>

  <!-- Podio de ganadores -->
  <div class="position-relative d-inline-block mt-4 text-center" style="max-width: 720px;">
    <img src="/images/ganadores.png" class="img-fluid w-100" alt="Podio Ganadores">

    <!-- ðŸ¥‡ Primer lugar -->
<div class="ganador-box box-oro">
  1Â° Lugar <br>
  <%= ranking[0] ? ranking[0].nombre + ' ' + ranking[0].apellido : 'VacÃ­o' %><br>
  Puntaje: <%= ranking[0] ? ranking[0].total_puntaje : '-' %><br>
  Tiempo: <%= ranking[0] ? formatTiempo(ranking[0].total_tiempo) : '-' %>
</div>

<!-- ðŸ¥ˆ Segundo lugar -->
<div class="ganador-box box-plata">
  2Â° Lugar <br>
  <%= ranking[1] ? ranking[1].nombre + ' ' + ranking[1].apellido : 'VacÃ­o' %><br>
  Puntaje: <%= ranking[1] ? ranking[1].total_puntaje : '-' %><br>
  Tiempo: <%= ranking[1] ? formatTiempo(ranking[1].total_tiempo) : '-' %>
</div>

<!-- ðŸ¥‰ Tercer lugar -->
<div class="ganador-box box-bronce">
  3Â° Lugar <br>
  <%= ranking[2] ? ranking[2].nombre + ' ' + ranking[2].apellido : 'VacÃ­o' %><br>
  Puntaje: <%= ranking[2] ? ranking[2].total_puntaje : '-' %><br>
  Tiempo: <%= ranking[2] ? formatTiempo(ranking[2].total_tiempo) : '-' %>
</div>
  </div>
</div>

<!-- Tabla general con acordeones -->
<div class="container tabla-resultados animate__animated animate__fadeInUp mt-4">
  <h4 class="text-center text-light mb-3">Resultados por Usuario</h4>
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>#</th>
        <th>Usuario</th>
        <th>Puntaje Total</th>
        <th>Tiempo Total</th>
        <th>Juegos</th>
      </tr>
    </thead>
    <tbody>
      <% if (ranking && ranking.length > 0) { %>
        <% ranking.forEach((user, idx) => { %>
          <tr>
            <td><%= idx+1 %></td>
            <td><%= user.nombre %> <%= user.apellido %></td>
            <td><%= user.total_puntaje %></td>
            <td><%= formatTiempo(user.total_tiempo) %></td>
            <td>
              <!-- Accordion con los juegos -->
              <div class="accordion" id="accordion<%= user.id %>">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="heading<%= user.id %>">
                    <button 
                      class="accordion-button collapsed" 
                      type="button" 
                      data-bs-toggle="collapse" 
                      data-bs-target="#collapse<%= user.id %>" 
                      aria-expanded="false" 
                      aria-controls="collapse<%= user.id %>">
                      Ver Juegos
                    </button>
                  </h2>
                  <div id="collapse<%= user.id %>" class="accordion-collapse collapse" aria-labelledby="heading<%= user.id %>" data-bs-parent="#accordion<%= user.id %>">
                    <div class="accordion-body">
                      <table class="table table-sm table-striped">
                        <thead>
                          <tr>
                            <th>Juego</th>
                            <th>Puntaje</th>
                            <th>Tiempo</th>
                            <th>Fecha</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% if (user.juegos && user.juegos.length > 0) { %>
                            <% user.juegos.forEach(j => { %>
                              <tr>
                                <td><%= j.juego %></td>
                                <td><%= j.puntaje %></td>
                                <td><%= formatTiempo(j.tiempo) %></td>
                                <td><%= j.fecha.toLocaleString() %></td>
                              </tr>
                            <% }) %>
                          <% } else { %>
                            <tr><td colspan="4">Sin resultados</td></tr>
                          <% } %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr><td colspan="5">No hay resultados registrados</td></tr>
      <% } %>
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
